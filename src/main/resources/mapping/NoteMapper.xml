<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dllyal.forum.mapper.NoteMapper" >
  <resultMap id="BaseResultMap" type="com.dllyal.forum.model.Note" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="nid" property="nid" jdbcType="INTEGER" />
    <result column="name" property="name" jdbcType="VARCHAR" />
    <result column="ncontext" property="ncontext" jdbcType="VARCHAR" />
    <result column="createtime" property="createtime" jdbcType="TIMESTAMP" />
    <result column="modifytime" property="modifytime" jdbcType="TIMESTAMP" />
    <result column="uid" property="uid" jdbcType="INTEGER" />
    <result column="tid" property="tid" jdbcType="INTEGER" />
    <result column="fathernid" property="fathernid" jdbcType="INTEGER" />
    <result column="fatheruid" property="fatheruid" jdbcType="INTEGER" />
    <result column="floor" property="floor" jdbcType="INTEGER" />
    <result column="state" property="state" jdbcType="INTEGER" />
  </resultMap>
  <sql id="Base_Column_List" >
    nid, name, ncontext, createtime, modifytime, uid, tid, fathernid, fatheruid, floor, state
  </sql>
  
  <!-- 添加主贴回复,即新楼层 -->
  <insert id="insertMainNote" parameterType="com.dllyal.forum.model.Note" >
  	insert into note 
	(
		ncontext, createtime, modifytime, uid, tid, fathernid, fatheruid, floor
	)
	values
	(
		#{ncontext,jdbcType=VARCHAR},NOW(),NOW(),#{uid,jdbcType=INTEGER},#{tid,jdbcType=INTEGER},#{fathernid,jdbcType=INTEGER},#{fatheruid,jdbcType=INTEGER},1+(SELECT COUNT(*) FROM note n WHERE n.fathernid=0 AND tid=#{tid,jdbcType=INTEGER})
	)
  </insert>
  
  <!-- 添加回复to回复  -->
  <insert id="insertNoteBack" parameterType="com.dllyal.forum.model.Note" >
  	insert into note 
	(
		ncontext, createtime, modifytime, uid, tid, fathernid, fatheruid, floor
	)
	values
	(
		#{ncontext,jdbcType=VARCHAR},NOW(),NOW(),#{uid,jdbcType=INTEGER},#{tid,jdbcType=INTEGER},#{fathernid,jdbcType=INTEGER},#{fatheruid,jdbcType=INTEGER},#{floor,jdbcType=INTEGER}
	)
  </insert>
  
  <!-- 某用户的普通帖子   -->
  <select id="selectNotesByUid" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    SELECT 
		n.nid,t.tname AS `name`,n.ncontext,n.createtime,n.modifytime,n.uid,n.tid,n.fathernid,n.fatheruid,n.floor,n.state 
	FROM 
		note n LEFT JOIN topic t ON n.tid=t.tid 
	WHERE n.uid=#{uid,jdbcType=INTEGER} ORDER BY n.createtime DESC
  </select>
  
  <!-- 根据tid获取楼内所有内容  -->
  <select id="selectNotesByTid" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from note
    where tid = #{tid,jdbcType=INTEGER} and fathernid=0 and state =0
  </select>
  
  <!-- 根据tid获取楼内所有回復内容  -->
  <select id="selectBacksByTid" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from note
    where tid = #{tid,jdbcType=INTEGER} and fathernid!=0 and state =0
  </select>
  
  <!-- 软删除帖子   -->
  <update id="updateDelNoteByNid" >
    UPDATE note SET state = 1 WHERE nid = #{nid,jdbcType=INTEGER}
  </update>
  
  <!-- 恢复软删除帖子   -->
  <update id="updateReNoteByNid" >
    UPDATE note SET state = 0 WHERE nid = #{nid,jdbcType=INTEGER}
  </update>
  
</mapper>